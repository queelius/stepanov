# Makefile for Stepanov Compression Benchmark Suite

CXX = g++
CXXFLAGS = -std=c++20 -I include -O3 -march=native
DEBUG_FLAGS = -g -fsanitize=address -fsanitize=undefined

# Targets
BENCHMARK_DEMO = benchmark_demo
TEST_BENCHMARK = test_benchmark

# Source files
BENCHMARK_DEMO_SRC = examples/benchmark_demo.cpp
TEST_BENCHMARK_SRC = test/test_benchmark.cpp

# Header dependencies
HEADERS = include/stepanov/compression/benchmark.hpp \
          include/stepanov/concepts.hpp

.PHONY: all clean test demo help

# Default target
all: $(BENCHMARK_DEMO) $(TEST_BENCHMARK)

# Build benchmark demo
$(BENCHMARK_DEMO): $(BENCHMARK_DEMO_SRC) $(HEADERS)
	@echo "Building benchmark demonstration..."
	$(CXX) $(CXXFLAGS) $(BENCHMARK_DEMO_SRC) -o $(BENCHMARK_DEMO)
	@echo "✓ Built $(BENCHMARK_DEMO)"

# Build test suite
$(TEST_BENCHMARK): $(TEST_BENCHMARK_SRC) $(HEADERS)
	@echo "Building test suite..."
	$(CXX) $(CXXFLAGS) $(TEST_BENCHMARK_SRC) -o $(TEST_BENCHMARK)
	@echo "✓ Built $(TEST_BENCHMARK)"

# Run tests
test: $(TEST_BENCHMARK)
	@echo "Running benchmark tests..."
	@./$(TEST_BENCHMARK)

# Run demo
demo: $(BENCHMARK_DEMO)
	@echo "Running benchmark demonstration..."
	@./$(BENCHMARK_DEMO)

# Debug build
debug: CXXFLAGS += $(DEBUG_FLAGS)
debug: all

# Clean build artifacts
clean:
	@echo "Cleaning build artifacts..."
	@rm -f $(BENCHMARK_DEMO) $(TEST_BENCHMARK) test_output.csv benchmark_results.csv
	@echo "✓ Clean complete"

# Help target
help:
	@echo "Stepanov Compression Benchmark Suite"
	@echo "====================================="
	@echo ""
	@echo "Targets:"
	@echo "  make all     - Build all executables"
	@echo "  make test    - Build and run test suite"
	@echo "  make demo    - Build and run demonstration"
	@echo "  make debug   - Build with debug symbols and sanitizers"
	@echo "  make clean   - Remove build artifacts"
	@echo "  make help    - Show this help message"
	@echo ""
	@echo "Examples:"
	@echo "  make test         # Run comprehensive tests"
	@echo "  make demo         # See benchmarking in action"
	@echo "  make clean all    # Clean rebuild"
	@echo ""
	@echo "Documentation:"
	@echo "  See docs/COMPRESSION_THEORY.md for theoretical background"
	@echo "  See include/stepanov/compression/benchmark.hpp for API reference"